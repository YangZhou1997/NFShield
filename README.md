# Build NFs for FireSim-simulated riscv quad-core rocket processor

## Prerequisite

### On firesim branch
You should switch to firesim branch.

### git-lfs
All traces are stored using git-lfs. To install, 
```
# on ubuntu
curl -s https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh | sudo bash
sudo apt-get install git-lfs
git lfs install
```
```
# on centos
sudo yum install git-lfs
```
For the other OS, please refer to [this page](https://github.com/git-lfs/git-lfs/wiki/Installation). 

Note that your git mush have version 2.3+ (checking by `git --version`) to let git-lfs work. 

After you install git-lfs and suitable version of git, run the following to get data: 
```
# inside rep
git lfs pull
```

### Customized FireSim
We customize the switch in FireSim with a packet load generator: https://github.com/YangZhou1997/firesim. 
Specifically, we change firesim/target-design/switch and firesim/deploy/runtools/ to include the packet load generator. 
You can check the detailed changes [here](https://github.com/YangZhou1997/firesim/compare/9d69e4e1380306f22ada6425b71515c17bbede93...main).

You should clone FireSim to `~/firesim`, as this rep assumes firesim there, and get trace data via git lfs.
```
git clone git@github.com:YangZhou1997/firesim.git ~/firesim
cd ~/firesim && git lfs pull
```

## Build embedded .c data files
We embed some necessary data into .c files, so bare-metal binaries can directly include (via `extern`) and load them without file IO. 
```
cd data_prep && ./hexembed_run.sh && cd -
```
This may take ~5mins

## Build riscv64 toolchain
```
cd ~/firesim && ./build-setup.sh fast
export PATH=$HOME/firesim/target-design/chipyard/riscv-tools-install/bin:$PATH
```
Enter `y` if prompting any confirmation questions.

## Prepare riscv64 NF binary
```
make CONFIG='-DNF_STRINGS=\"l2_fwd\"'
```
This will build a `nftop.riscv` binary that runs l2_fwd on the first core (while the rest three cores are busy waiting), and copy it with necessary `.ini`, and `.json` to `~/firesim/deploy/workloads`. You can then go there to start firesim simulation. 

You can change `DNF_STRINGS` to other NF to test new NFs: `acl_fw`, `dpi`, `lpm`, `maglev`, `monitoring`, `nat_tcp_v4`, `mem_test`. 

We can build a `nftop.riscv` that runs different NFs on four cores by 
```
make CONFIG='-DNF_STRINGS=\"l2_fwd:lpm:maglev:acl_fw\"'
```

A fresh make would take ~10min, in order to build the necessary embedded data from `data_embed/*.c`. After the fresh make, these embedded data will be stored as `*.o` and reused in the following make. 

Note that before testing new NFs by remaking with a new `CONFIG`, you should `make clean` to clear old binaries (eg, nftop.riscv, syscalls.o), but it will **not** remove `*.o` embedded data (which rarely gets changed). 

### Virtualizing IceNIC in software

Due to the lack of hardware IO virtualization (eg, multiple IceNIC registers, multiple packet RX/TX queues), we implement a software-based IceNIC sharing mechanism. 

* Multiple NFs use spinlock to share one set of IceNIC registers. Note this is not efficient as it disallows overlapping packet IO with computation via batching. 
* Packets generated by the switch are assigned to a specific core based on their `eth_type` field: `core_id = eth_type - 0x1234`. This is achieved by having each core maintain a RX packet descriptor (ie, packet buffer address, and packet length) queue in memory. Any time when one core pulls a packet, it will put the packet descriptor to the right queue based on the `eth_type` field. 

## Run firesim simulation
```
cd ~/firesim/ && source sourceme-f1-manager.sh && firesim managerinit
cd ~/firesim/deploy
firesim launchrunfarm -c workloads/nftop.ini
firesim infrasetup -c workloads/nftop.ini
firesim runworkload -c workloads/nftop.ini
firesim terminaterunfarm -c workloads/nftop.ini
```

## Get simulation results
You can either check the switchlog in firesim manager instance after simulation ends, or login to the switch simulation instance, and `cat switch_slot_0/switchlog`, where you can see the packet processing rate and bandwidth. You may also `cat sim_slot_0/uartlog` in the switch simulation instance to check some statistics printed by the NF binary; but we mostly use the rate and bandwidth reported by `switchlog` as measurement results. 